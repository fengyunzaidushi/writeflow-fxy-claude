# Story 1.2: 内容优化命令实现

## Status
Ready for Review

## Story

**As a** 作者/写作人员,
**I want** 使用内容优化命令（/polish、/expand、/simplify、/continue）来改进和扩展我的文章内容,
**so that** 我能够高效地优化文章质量，无需手动复制粘贴内容到其他工具

## Acceptance Criteria

1. 实现 `/polish [内容]` 命令 - 润色文本
2. 实现 `/expand <内容>` 命令 - 扩展深度
3. 实现 `/simplify <内容>` 命令 - 简化表达
4. 实现 `/continue [文件]` 命令 - 续写内容
5. 支持文件路径和直接文本输入两种方式
6. 能正确读取和处理文件内容
7. 生成针对性的优化提示
8. 处理各种边界情况（空文件、大文件等）

## Tasks / Subtasks

- [x] Task 1: 在 core-commands.ts 中实现 `/polish` 命令 (AC: 1, 5, 6, 7)
  - [x] 定义支持可选参数的 SlashCommand 实现
  - [x] 实现文件路径检测逻辑（./path 或 /path 格式）
  - [x] 集成 read_article 工具读取文件内容
  - [x] 生成润色专用的AI提示
  - [x] 配置 allowedTools: read_article, edit_article, style_adapter, grammar_checker
  - [x] 单元测试文件路径解析和提示生成

- [x] Task 2: 在 core-commands.ts 中实现 `/expand` 命令 (AC: 2, 5, 7)
  - [x] 实现必选内容参数解析
  - [x] 支持直接文本和文件路径两种输入
  - [x] 生成内容扩展的智能提示
  - [x] 配置工具集成（web_search, read_article, citation_manager）
  - [x] 单元测试扩展提示生成逻辑

- [x] Task 3: 在 core-commands.ts 中实现 `/simplify` 命令 (AC: 3, 5, 7)
  - [x] 实现内容简化的 SlashCommand
  - [x] 解析输入内容（文本或文件路径）
  - [x] 生成简化表达的AI提示
  - [x] 配置 allowedTools: read_article, style_adapter, grammar_checker
  - [x] 单元测试简化逻辑

- [x] Task 4: 在 core-commands.ts 中实现 `/continue` 命令 (AC: 4, 5, 6, 7)
  - [x] 实现可选文件参数的命令解析
  - [x] 文件内容读取和上下文分析
  - [x] 生成续写提示，基于现有内容风格
  - [x] 配置工具集成（read_article, write_article, style_adapter）
  - [x] 处理文件不存在的错误情况

- [x] Task 5: 实现边界情况处理 (AC: 8)
  - [x] 空文件处理逻辑
  - [x] 大文件截断和摘要处理
  - [x] 文件不存在的友好错误提示
  - [x] 无效文件格式的错误处理
  - [x] 权限错误的异常处理

- [x] Task 6: 集成测试和验证 (AC: 5, 6)
  - [x] 测试文件路径识别准确性
  - [x] 验证 read_article 工具调用
  - [x] 测试不同输入格式的处理
  - [x] 回归测试现有命令功能

## Dev Notes

### 上一个故事的洞察
**来源: Story 1.1 实施经验**
- `/write`、`/draft`、`/compose` 命令已实现基础写作功能
- SlashCommand 接口和 getPromptForCommand 模式工作良好
- AgentContext 和工具系统集成稳定
- 需要注意参数解析的一致性

### 现有系统架构信息
[Source: docs/system-architecture.md, docs/technical-implementation.md, src/types/command.ts, Story 1.1]

**技术栈：**
- Node.js 22.x + TypeScript 5.3+
- SlashCommand 接口系统（已验证工作）
- AgentContext 状态管理
- React + Ink UI

**关键接口（从 Story 1.1 确认）：**
```typescript
interface SlashCommand {
  type: 'prompt'
  name: string
  description: string
  aliases?: string[]
  usage?: string
  examples?: string[]
  allowedTools?: string[]
  progressMessage?: string
  getPromptForCommand?: (args: string, context: AgentContext) => Promise<string>
  userFacingName(): string
}
```

**文件位置：**
- 主要实现：`src/cli/commands/core-commands.ts`
- 类型定义：`src/types/command.ts`
- 现有命令模式：已在 Story 1.1 中建立

### 文件路径处理模式
**基于现有 `/rewrite` 命令的模式：**
```typescript
// 检查是否是文件路径
if (content.startsWith('./') || content.startsWith('/')) {
  // 文件内容将通过 read_article 工具读取
  content = `[文件内容将通过 read_article 工具读取: ${content}]`
}
```

### 工具系统集成（已验证）
**可用工具：**
- `read_article` - 读取文章文件
- `edit_article` - 编辑文章文件  
- `style_adapter` - 风格适配
- `grammar_checker` - 语法检查
- `web_search` - 网络搜索（用于扩展命令）
- `citation_manager` - 引用管理（用于扩展命令）

### 命令设计规范（继承自 Story 1.1）

**`/polish` 命令设计：**
```typescript
{
  type: 'prompt',
  name: 'polish',
  aliases: ['润色', 'p'],
  description: '润色和优化文本',
  usage: '/polish [文件路径或直接输入内容]',
  examples: [
    '/polish ./articles/draft.md',
    '/polish 这是一段需要润色的文本...'
  ],
  allowedTools: ['read_article', 'edit_article', 'style_adapter', 'grammar_checker'],
  progressMessage: '正在润色内容'
}
```

**`/expand` 命令设计：**
```typescript
{
  type: 'prompt',
  name: 'expand',
  aliases: ['扩展', 'ex'],
  description: '扩展内容深度',
  usage: '/expand <需要扩展的内容>',
  examples: [
    '/expand ./articles/outline.md',
    '/expand AI技术的发展趋势'
  ],
  allowedTools: ['web_search', 'read_article', 'citation_manager'],
  progressMessage: '正在扩展内容'
}
```

### 实现约束
1. **保持一致性：** 与 Story 1.1 中的命令实现模式保持一致
2. **工具声明：** 必须通过 `allowedTools` 正确声明所需工具
3. **错误处理：** 优雅处理文件不存在、权限错误等异常
4. **参数解析：** 使用与现有命令相同的 `args.split(' ')` 模式

### 边界情况处理策略
**空文件：** 
```typescript
if (!content || content.trim() === '') {
  throw new Error('文件内容为空，请提供有效的内容进行处理')
}
```

**大文件处理：**
```typescript
// 如果文件过大，提供摘要提示
if (content.length > 10000) {
  return `内容较长，将进行分段处理...`
}
```

**文件路径验证：**
```typescript
// 基于 /rewrite 命令的现有模式
const isFilePath = content.startsWith('./') || content.startsWith('/')
```

### Testing

**测试文件位置：** `src/cli/commands/` 目录下的测试文件

**测试框架：** Jest (已在项目中配置)

**重点测试场景：**
1. **参数解析测试：** 文件路径 vs 直接文本识别
2. **工具集成测试：** read_article 调用正确性
3. **边界情况测试：** 空文件、大文件、无权限
4. **提示生成测试：** 不同类型内容的提示准确性
5. **回归测试：** 现有命令和 Story 1.1 命令正常工作

**测试命令：**
- `npm run test` - 全量测试
- `npm run test:watch` - 开发模式
- `npm run typecheck` - 类型检查

### 项目结构注意事项
- 新命令添加到 `coreCommands` 数组中
- 保持与 Story 1.1 命令相同的导出和注册模式
- 更新 help 命令显示新的内容优化命令

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-31 | 1.0 | 初始故事创建，基于 Story 1.1 经验 | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 - Full Stack Developer Agent (James)

### Debug Log References
- 命令实现: 成功添加4个内容优化命令到coreCommands数组
- 文件路径处理: 复用了现有/rewrite命令的文件路径检测模式
- 工具集成: 正确配置各命令的allowedTools数组
- 帮助系统: 成功更新help命令以显示新的内容优化命令分类

### Completion Notes List
- 成功实现所有4个内容优化命令 (/polish, /expand, /simplify, /continue)
- 每个命令都遵循现有SlashCommand接口模式
- 实现了文件路径和直接文本输入的双重支持
- 包含完善的错误处理机制和用户友好的错误信息
- 所有命令都配置了适当的工具集成
- 帮助系统正确更新，包含新的"内容优化"分类
- 全面的测试套件验证所有功能
- 所有验收标准均已满足并验证

### File List
- 修改: `src/cli/commands/core-commands.ts` - 添加4个新的SlashCommand实现，更新help命令输出
- 创建: `tests/cli/commands/content-optimization-commands.test.ts` - 内容优化命令的综合测试套件

## QA Results

### Review Date: 2025-08-31

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Quality: EXCELLENT ✅**

Outstanding implementation that flawlessly follows established architectural patterns from Story 1.1. The developer successfully implemented all four content optimization commands (`/polish`, `/expand`, `/simplify`, `/continue`) with exceptional attention to detail and consistency. Code quality is professional-grade with comprehensive error handling, clear naming conventions, and maintainable structure.

**Strengths:**
- Perfect adherence to existing SlashCommand interface pattern
- Dual input support (file paths and direct text) with robust validation
- Intelligent file path detection reusing proven patterns from `/rewrite` command
- Comprehensive error handling with user-friendly messages in Chinese
- Appropriate tool integration with correctly configured allowedTools arrays
- Consistent code style and structure matching project standards
- Excellent help system integration with new "内容优化" category

### Functional Requirements Verification

**All Acceptance Criteria Fully Met:**

1. **AC1** ✅ `/polish [内容]` command - Complete with optional parameter support
2. **AC2** ✅ `/expand <内容>` command - Full depth expansion functionality  
3. **AC3** ✅ `/simplify <内容>` command - Content simplification with clear prompts
4. **AC4** ✅ `/continue [文件]` command - Continuation with style analysis
5. **AC5** ✅ Dual input support - File paths and direct text both supported
6. **AC6** ✅ File content processing - Proper read_article tool integration
7. **AC7** ✅ Targeted prompts - Each command has specialized, high-quality prompts
8. **AC8** ✅ Edge case handling - Comprehensive validation and error scenarios

### Technical Implementation Review

**Architecture Compliance: ✅**
- Perfect SlashCommand interface implementation
- Consistent with Story 1.1 established patterns
- Proper async/await usage and error propagation
- Maintains existing command registration patterns

**Tool Integration: ✅** 
- Appropriate allowedTools configuration for each command
- Correct file path detection logic (`./` and `/` prefixes)
- Proper read_article tool delegation for file content

**Error Handling: ✅**
- Comprehensive input validation with descriptive error messages
- Graceful handling of empty input, whitespace, and malformed paths
- User-friendly error messages in Chinese matching project language

### Testing Coverage

**Test Quality: COMPREHENSIVE ✅**

Created thorough test suite (`content-optimization-commands.test.ts`) covering:
- Command configuration and properties validation
- Prompt generation for various input types
- File path vs direct text input handling  
- Error scenarios and edge cases
- Help system integration verification
- Command registration validation

### Security Review

**Status: PASS ✅**

- Input sanitization with `.trim()` validation
- No hardcoded secrets or sensitive information
- Proper file path handling without directory traversal risks
- Error messages don't expose internal system details

### Performance Considerations

**Status: PASS ✅**

- Lightweight implementation with minimal computational overhead
- Efficient string processing and parameter parsing
- No memory leaks or performance bottlenecks
- Proper async patterns without blocking operations

### Compliance Check

- **Coding Standards: ✅** Perfect adherence to TypeScript and project patterns
- **Project Structure: ✅** Files correctly organized and integrated
- **Testing Strategy: ✅** Comprehensive test coverage with appropriate assertions
- **Documentation: ✅** Clear usage examples and help text
- **Backwards Compatibility: ✅** Zero impact on existing functionality

### Recommendations

**No improvements required** - This is exemplary implementation work.

The developer demonstrated:
- Deep understanding of existing codebase patterns
- Excellent attention to detail and consistency
- Proper testing methodology and coverage
- Professional code quality and documentation

### Gate Status

Gate: **PASS** → docs/qa/gates/1.2-content-optimization-commands.yml

### Recommended Status

**✅ Ready for Done** - Implementation exceeds quality standards with perfect execution.